<!DOCTYPE html>
<html lang="en">
	<head>
		
  		
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7Z74BTZ0TM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-7Z74BTZ0TM');
</script>
  		
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>1 billion rows challenge in MySQL</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://ftisiot.net/index.xml">
		<link rel="canonical" href="https://ftisiot.net/posts/1browsmysql/">
		
		<link rel="shortcut icon" type="image/png" href="https://ftisiot.net/apple-touch-icon-precomposed.png">
		<meta name="description" content="Sorting 1 billion rows challenge with MySQL">
		
		

		
		<meta property="og:title" content="1 billion rows challenge in MySQL" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://ftisiot.net/images/2024/query.png" />
		<meta property="og:description" content="Sorting 1 billion rows challenge with MySQL" />
		<meta property="og:url" content="https://ftisiot.net/posts/1browsmysql/" />
		<meta property="og:site_name" content="1 billion rows challenge in MySQL" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://ftisiot.net/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://ftisiot.net/css/story.css" />
		<link rel="stylesheet" href="https://ftisiot.net/css/descartes.css" />
		
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
		<link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i,700,700i|Quattrocento:400,700|Spectral:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
		

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://ftisiot.net/js/story.js"></script>

	</head>
	<body class="ma0 bg-white section-posts page-kind-page is-page-true ">
		
		<header class="cover bg-top" style="background-image: url('https://ftisiot.net/images/2024/query.png'); background-position: center;">
			<div class="bg-black-30 bb bt">

				<nav class="hide-print sans-serif  border-box pa3 ph5-l">
					<a href="https://ftisiot.net" title="Home">
						<img src="https://ftisiot.net/img/logo.jpg" class="w2 h2 br-100" alt="ftisiot ideas about food and life" />
					</a>
					<div class="fr h2 pv2 tr">
						<a class="link f5 ml2 dim near-white" href="/who">who</a>
						<a class="link f5 ml2 dim near-white" href="/speaking-activities">talks</a>
						<a class="link f5 ml2 dim near-white" href="/suggestions-verona">suggestions</a>
						<a class="link f5 ml2 dim near-white" href="/postgresqljson/main">json-pg</a>
						<a class="link f5 ml2 dim near-white" href="/mysqljson/main">json-mysql</a>
						<a class="link f5 ml2 dim near-white" href="https://www.youtube.com/channel/UCTJ4oA3-T3RdmM2OJ7d8cJg"><i class="fab fa-youtube-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://twitter.com/ftisiot/"><i class="fab fa-twitter-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://github.com/ftisiot/"><i class="fab fa-github-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.linkedin.com/in/francescotisiot/"><i class="fab fa-linkedin"></i></a>
						<a class="link f5 ml2 dim near-white fas fa-rss-square" href="https://ftisiot.net/index.xml" title="RSS Feed"></a>
						<a class="link f5 ml2 dim near-white fas fa-search" href="https://ftisiot.net/search/" role="search" title="Search"></a>
					</div>
				</nav>

				<div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
					<h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">1 billion rows challenge in MySQL</h1>
					<h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">
						
						
							
								Published
								<time datetime="2024-01-26T14:43:29&#43;01:00">Jan 26, 2024</time>
								<span class="display-print">by </span>
								 in <a href="https://ftisiot.net/categories/mysql" class="no-underline category near-white dim">MySQL</a>, <a href="https://ftisiot.net/categories/sorting" class="no-underline category near-white dim">Sorting</a>, <a href="https://ftisiot.net/categories/1brows" class="no-underline category near-white dim">1brows</a>
								<span class="display-print">at https://ftisiot.net/posts/1browsmysql/</span>
							
						
					</h2>
				</div>

				
				
				
				<div class="w-100 cf hide-print">
					<a class="fr f6 ma0 pa2 link white-50 dim fas fa-camera" href="ftisiot" title="Photo Credit"></a>
				</div>
				
				

			</div>
		</header>
		
		<main role="main">
		
<article class="center bg-white br-3 pv1 ph4 lh-copy f5 nested-links mw7">
	<p>Earlier this month I wrote a piece on solving <a href="https://www.linkedin.com/in/gunnar-morling-2b44b7229/">Gunnar Morling</a> interesting <a href="https://www.morling.dev/blog/one-billion-row-challenge/">1 billion rows challenge</a> in <a href="/posts/1brows">PostgreSQL and ClickHouse</a>. Since <a href="http://aiven.io">Aiven</a> provides also MySQL, I wanted to give it a try. TLDR; The results are much slower than PG and ClickHouse, do you have any suggestion on how to improve?</p>
<blockquote>
<p>Alert: the following is <strong>NOT</strong> a benchmark! The test is done with default installations of both databases and NO optimization. The blog only shows the technical viability of a solution.</p>
</blockquote>

<p>¬†<p style="background: #C1E1C1;border: 2px solid #b4d3b2;border-radius: 15px;text-align: center;">üëâ Need a FREE MySQL database?üëà<br>ü¶Ä Check <a href="https://go.aiven.io/francesco-signup">Aiven&rsquo;s FREE plans</a>! ü¶Ä<br>
Need to optimize your SQL query?  <br><br>
üêß Check <a href="https://www.eversql.com/?utm_medium=organic&utm_source=ext_blog&utm_content=ftisiotwebsite">EverSQL</a>! üêß</p></p>

<h2 id="install-mysql-on-mac">Install MySQL on Mac</h2>
<p>The first step is to have an handy MySQL, I could use the <a href="https://go.aiven.io/francesco-signup">Aiven FREE tier</a>, but, as for the previous PostgreSQL and ClickHouse example, decided to install it locally. To do it, you can execute:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>brew install mysql
</span></span></code></pre></div><p>then we can start with</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>brew services start mysql
</span></span></code></pre></div><h2 id="connect-to-mysql-and-setup-a-database">Connect to MySQL and setup a database</h2>
<p>Once the installation process is completed, we can connect to the local MySQL with the following command:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mysql -u root
</span></span></code></pre></div><blockquote>
<p>For this test we&rsquo;re going to use the <code>root</code> user. However is highly suggested to create a non root user for any sensible work with a database.</p>
</blockquote>
<p>We can now create a database with:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">DATABASE</span><span style="color:#bbb"> </span><span style="color:#666">1</span>brow;<span style="color:#bbb">
</span></span></span></code></pre></div><p>And start using it with:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>USE<span style="color:#bbb"> </span><span style="color:#666">1</span>brow;<span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="loading-the-data-in-mysql">Loading the data in MySQL</h3>
<p>In order to properly solve the challenge we need to load the data into MySQL. We can create a table called <code>TEST</code> with the needed columns with:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>TEST<span style="color:#bbb"> </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>id<span style="color:#bbb"> </span><span style="color:#008000">BIGINT</span><span style="color:#bbb"> </span>AUTO_INCREMENT<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">PRIMARY</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">KEY</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>city<span style="color:#bbb"> </span><span style="color:#008000">VARCHAR</span>(<span style="color:#666">100</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>temperature<span style="color:#bbb"> </span><span style="color:#008000">FLOAT</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>And populate it with:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">LOAD</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">DATA</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">LOCAL</span><span style="color:#bbb"> </span>INFILE<span style="color:#bbb"> </span><span style="color:#ba2121">&#34;measurements.txt.new&#34;</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">IGNORE</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">INTO</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>TEST<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>COLUMNS<span style="color:#bbb"> </span>TERMINATED<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">BY</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;;&#39;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>LINES<span style="color:#bbb"> </span>TERMINATED<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">BY</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;\n&#39;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">IGNORE</span><span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb"> </span>LINES;<span style="color:#bbb">
</span></span></span></code></pre></div><p>If you receive the error <code>ERROR 3948 (42000): Loading local data is disabled; this must be enabled on both the client and server sides</code>, we can enable it with:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SET</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">GLOBAL</span><span style="color:#bbb"> </span>local_infile<span style="color:#666">=</span><span style="color:#666">1</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>Compared to <a href="/posts/1brows">PostgreSQL and ClickHouse</a>, MySQL doesn&rsquo;t seem to have a native option to read from an external <code>CSV</code> file. The <a href="https://dev.mysql.com/doc/refman/8.0/en/csv-storage-engine.html">MySQL CSV Engine</a> is available, but it requires you to move the CSV within MySQL&rsquo;s data folder.</p>
<h3 id="mysql-results">MySQL Results</h3>
<p>Once the data is loaded, we can use a similar query to the <a href="/posts/1brows">PostgreSQL and ClickHouse</a> ones to perform the correct ordering.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">WITH</span><span style="color:#bbb"> </span>AGG<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>city,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">           </span><span style="color:#008000;font-weight:bold">MIN</span>(temperature)<span style="color:#bbb"> </span>min_measure,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">           </span><span style="color:#008000;font-weight:bold">cast</span>(<span style="color:#008000;font-weight:bold">AVG</span>(temperature)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span><span style="color:#008000">DECIMAL</span>(<span style="color:#666">8</span>,<span style="color:#666">1</span>))<span style="color:#bbb"> </span>mean_measure,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">           </span><span style="color:#008000;font-weight:bold">MAX</span>(temperature)<span style="color:#bbb"> </span>max_measure<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>test<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">GROUP</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">BY</span><span style="color:#bbb"> </span>city<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>GROUP_CONCAT(CITY,<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;=&#39;</span>,<span style="color:#bbb"> </span>CONCAT(min_measure,<span style="color:#ba2121">&#39;/&#39;</span>,<span style="color:#bbb"> </span>mean_measure,<span style="color:#ba2121">&#39;/&#39;</span>,<span style="color:#bbb"> </span>max_measure)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">ORDER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">BY</span><span style="color:#bbb"> </span>CITY<span style="color:#bbb"> </span>SEPARATOR<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;, &#39;</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>AGG<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>The above query is using <code>GROUP_CONCAT</code> allows to return the concatenated list of cities once min/mean/max measures have been calculated.</p>
<h2 id="mysql-timing">MySQL Timing</h2>
<p>To get the timing I created a file called <code>test.sql</code> with the entire set of commands:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>TEST<span style="color:#bbb"> </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>id<span style="color:#bbb"> </span><span style="color:#008000">BIGINT</span><span style="color:#bbb"> </span>AUTO_INCREMENT<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">PRIMARY</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">KEY</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>city<span style="color:#bbb"> </span><span style="color:#008000">VARCHAR</span>(<span style="color:#666">100</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>temperature<span style="color:#bbb"> </span><span style="color:#008000">float</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>)<span style="color:#bbb"> </span>ENGINE<span style="color:#666">=</span>MEMORY;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">SET</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">GLOBAL</span><span style="color:#bbb"> </span>local_infile<span style="color:#666">=</span><span style="color:#666">1</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">LOAD</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">DATA</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">LOCAL</span><span style="color:#bbb"> </span>INFILE<span style="color:#bbb"> </span><span style="color:#ba2121">&#34;measurements.txt&#34;</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">IGNORE</span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">INTO</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>TEST<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>COLUMNS<span style="color:#bbb"> </span>TERMINATED<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">BY</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;;&#39;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>LINES<span style="color:#bbb"> </span>TERMINATED<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">BY</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;\n&#39;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">IGNORE</span><span style="color:#bbb"> </span><span style="color:#666">1</span><span style="color:#bbb"> </span>LINES<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>(city,<span style="color:#bbb"> </span>temperature);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">WITH</span><span style="color:#bbb"> </span>AGG<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>city,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">           </span><span style="color:#008000;font-weight:bold">MIN</span>(temperature)<span style="color:#bbb"> </span>min_measure,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">           </span><span style="color:#008000;font-weight:bold">cast</span>(<span style="color:#008000;font-weight:bold">AVG</span>(temperature)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">AS</span><span style="color:#bbb"> </span><span style="color:#008000">DECIMAL</span>(<span style="color:#666">8</span>,<span style="color:#666">1</span>))<span style="color:#bbb"> </span>mean_measure,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">           </span><span style="color:#008000;font-weight:bold">MAX</span>(temperature)<span style="color:#bbb"> </span>max_measure<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>test<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">GROUP</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">BY</span><span style="color:#bbb"> </span>city<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>GROUP_CONCAT(CITY,<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;=&#39;</span>,<span style="color:#bbb"> </span>CONCAT(min_measure,<span style="color:#ba2121">&#39;/&#39;</span>,<span style="color:#bbb"> </span>mean_measure,<span style="color:#ba2121">&#39;/&#39;</span>,<span style="color:#bbb"> </span>max_measure)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">ORDER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">BY</span><span style="color:#bbb"> </span>CITY<span style="color:#bbb"> </span>SEPARATOR<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;, &#39;</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>AGG<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>And a then timed with:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#008000">time</span> mysql --local-infile<span style="color:#666">=</span><span style="color:#666">1</span> -u root -vvv 1brow &lt; test.sql
</span></span></code></pre></div><p>The timing is <code>43 min 57.99 sec</code> with over <code>33 min 32.15 sec</code> spent on the ingestion phase and <code>10 min 25.77 sec</code> on the query. The file <code>test.ibd</code> being over <code>40GB</code> almost 4x times the original size of the <code>measurements.txt</code> file (<code>13GB</code>). You can check the size of the table file with the following command:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ls -lh /usr/local/var/mysql/1brow/test.idb
</span></span></code></pre></div><blockquote>
<p>Alert: the following is <strong>NOT</strong> a benchmark! The test is done with default installations of both databases and NO optimization. The blog only shows the technical viability of a solution.</p>
</blockquote>
<p>You might need to tweak the <code>connect_timeout</code> parameter in <code>my.cnf</code> to raise the connection timeout to 100 minutes in order to wait for the loading and query process to finish.</p>
<h2 id="speed-up-mysql-timing-by-using-the-memory-engine">Speed up MySQL timing by using the MEMORY Engine</h2>
<p>MySQL has a <a href="https://dev.mysql.com/doc/refman/8.0/en/memory-storage-engine.html">Memory storage engine</a> which will avoid writing to disk and store the entire table in RAM. As per documentation, this is not a safe option for production workloads since:</p>
<blockquote>
<p>Because the data is vulnerable to crashes, hardware issues, or power outages, only use these tables as temporary work areas or read-only caches for data pulled from other tables.</p>
</blockquote>
<p>The only change we have to perform, in order to use the <code>MEMORY</code> storage engine is to redefine our <code>test</code> table as:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>TEST<span style="color:#bbb"> </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>id<span style="color:#bbb"> </span><span style="color:#008000">BIGINT</span><span style="color:#bbb"> </span>AUTO_INCREMENT<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">PRIMARY</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">KEY</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>city<span style="color:#bbb"> </span><span style="color:#008000">VARCHAR</span>(<span style="color:#666">100</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>temperature<span style="color:#bbb"> </span><span style="color:#008000">FLOAT</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>)<span style="color:#bbb"> </span>ENGINE<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>MEMORY;<span style="color:#bbb">
</span></span></span></code></pre></div><p>But, when making the change and retrying the script you might hit the <code>ERROR 1114 (HY000) at line 9: The table 'test' is full</code> since the data doesn&rsquo;t fit the memory allocated to MySQL. To avoid this we can set the following flags to raise the allocated memory to <code>64GB</code>:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SET</span><span style="color:#bbb"> </span>max_heap_table_size<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#666">1024</span><span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#bbb"> </span><span style="color:#666">1024</span><span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#bbb"> </span><span style="color:#666">1024</span><span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#bbb"> </span><span style="color:#666">64</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>However, also this didn&rsquo;t work, and stopped my test after waiting for over <code>40 minutes</code> for just the loading time.</p>
<p>Do you have ideas on how to speed up the process in MySQL? I&rsquo;m all üëÇ on X (ex Twitter) @ftisiot!</p>
</article>

		</main>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide">
		<div class="about-the-author">
		
			
			
				
					<hr>
<p><img src="/images/ftisiot.jpg" alt="Francesco Tisiot"></p>
<p><a href="https://www.linkedin.com/in/francescotisiot/"><b class="fab fa-linkedin"></b></a> <a href="https://twitter.com/FTisiot"><b class="fab fa-twitter"></b></a><a rel="me" href="https://data-folks.masto.host/@ftisiot">Mastodon</a> Francesco comes from Verona, Italy üáÆüáπ and works as a Staff Developer Advocate at Aiven. With his many years of experience as a data analyst, he has stories to tell and advice for data-wranglers  everywhere. Francesco loves sharing knowledge with others as a speaker and writer, and is on a mission to defend the world from bad Italian food!!</p>

				
			
		
		</div>
		
	</div>

		
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://ftisiot.net/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2024 
			</p>
		</footer>
		
	
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-7Z74BTZ0TM', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	
	</body>
</html>
