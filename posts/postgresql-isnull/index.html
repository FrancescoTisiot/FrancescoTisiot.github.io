<!DOCTYPE html>
<html lang="en">
	<head>
		
  		
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7Z74BTZ0TM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-7Z74BTZ0TM');
</script>
  		
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>11 Lessons to learn when using NULLs in PostgreSQL¬Æ</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="https://ftisiot.net/index.xml">
		<link rel="canonical" href="https://ftisiot.net/posts/postgresql-isnull/">
		
		<link rel="shortcut icon" type="image/png" href="https://ftisiot.net/apple-touch-icon-precomposed.png">
		<meta name="description" content="11 Lessons to learn when using NULLs in PostgreSQL¬Æ">
		
		

		
		<meta property="og:title" content="11 Lessons to learn when using NULLs in PostgreSQL¬Æ" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://ftisiot.net/images/2024/isnullgreyed.png" />
		<meta property="og:description" content="11 Lessons to learn when using NULLs in PostgreSQL¬Æ" />
		<meta property="og:url" content="https://ftisiot.net/posts/postgresql-isnull/" />
		<meta property="og:site_name" content="11 Lessons to learn when using NULLs in PostgreSQL¬Æ" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="https://ftisiot.net/css/tachyons.min.css" />
		<link rel="stylesheet" href="https://ftisiot.net/css/story.css" />
		<link rel="stylesheet" href="https://ftisiot.net/css/descartes.css" />
		
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
		<link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i,700,700i|Quattrocento:400,700|Spectral:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
		

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="https://ftisiot.net/js/story.js"></script>

	</head>
	<body class="ma0 bg-white section-posts page-kind-page is-page-true ">
		
		<header class="cover bg-top" style="background-image: url('https://ftisiot.net/images/2024/isnullgreyed.png'); background-position: center;">
			<div class="bg-black-30 bb bt">

				<nav class="hide-print sans-serif  border-box pa3 ph5-l">
					<a href="https://ftisiot.net" title="Home">
						<img src="https://ftisiot.net/img/logo.jpg" class="w2 h2 br-100" alt="ftisiot ideas about food and life" />
					</a>
					<div class="fr h2 pv2 tr">
						<a class="link f5 ml2 dim near-white" href="/who">who</a>
						<a class="link f5 ml2 dim near-white" href="/speaking-activities">talks</a>
						<a class="link f5 ml2 dim near-white" href="/suggestions-verona">suggestions</a>
						<a class="link f5 ml2 dim near-white" href="/postgresqljson/main">json-pg</a>
						<a class="link f5 ml2 dim near-white" href="/mysqljson/main">json-mysql</a>
						<a class="link f5 ml2 dim near-white" href="https://www.youtube.com/channel/UCTJ4oA3-T3RdmM2OJ7d8cJg"><i class="fab fa-youtube-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://twitter.com/ftisiot/"><i class="fab fa-twitter-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://github.com/ftisiot/"><i class="fab fa-github-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.linkedin.com/in/francescotisiot/"><i class="fab fa-linkedin"></i></a>
						<a class="link f5 ml2 dim near-white fas fa-rss-square" href="https://ftisiot.net/index.xml" title="RSS Feed"></a>
						<a class="link f5 ml2 dim near-white fas fa-search" href="https://ftisiot.net/search/" role="search" title="Search"></a>
					</div>
				</nav>

				<div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
					<h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">11 Lessons to learn when using NULLs in PostgreSQL¬Æ</h1>
					<h2 class="near-white mt3-l mb4-l fw1 f6 f3-l measure-wide-l center lh-copy mt2 mb3">
						
						
							
								Published
								<time datetime="2024-02-28T08:00:29&#43;01:00">Feb 28, 2024</time>
								<span class="display-print">by </span>
								 in <a href="https://ftisiot.net/categories/postgresql" class="no-underline category near-white dim">PostgreSQL</a>, <a href="https://ftisiot.net/categories/sql" class="no-underline category near-white dim">SQL</a>, <a href="https://ftisiot.net/categories/" class="no-underline category near-white dim"></a>, <a href="https://ftisiot.net/categories/isnull" class="no-underline category near-white dim">Isnull</a>, <a href="https://ftisiot.net/categories/coalesce" class="no-underline category near-white dim">Coalesce</a>
								<span class="display-print">at https://ftisiot.net/posts/postgresql-isnull/</span>
							
						
					</h2>
				</div>

				
				
				
				<div class="w-100 cf hide-print">
					<a class="fr f6 ma0 pa2 link white-50 dim fas fa-camera" href="ftisiot" title="Photo Credit"></a>
				</div>
				
				

			</div>
		</header>
		
		<main role="main">
		
<article class="center bg-white br-3 pv1 ph4 lh-copy f5 nested-links mw7">
	<p>A boolean value should only contain two values, <code>True</code> or <code>False</code>, but is it correct? Usually people assume so, but sometimes miss the fact that there could be the <strong>absence</strong> of the value all-together. In databases this is absence is usually stored as <code>NULL</code> and this blog showcases how to find them, use them properly and 11 lessons to learn to be a <code>NULL</code> Pro!</p>
<blockquote>
<p>Keep in mind, it&rsquo;s not only booleans that can contain <code>NULL</code> values, it&rsquo;s all the columns where you don&rsquo;t define a <code>NOT NULL</code> constraint!</p>
</blockquote>
<p>¬†<p style="background: #C1E1C1;border: 2px solid #b4d3b2;border-radius: 15px;text-align: center;">üëâ Need a FREE PostgreSQL database?üëà<br>ü¶Ä Check <a href="https://go.aiven.io/francesco-signup">Aiven&rsquo;s FREE plans</a>! ü¶Ä <br>
‚ö°Ô∏è Need to optimize your SQL query with AI?‚ö°Ô∏è <br><br>
üêß Check  <a href="https://www.eversql.com/?utm_medium=organic&utm_source=ext_blog&utm_content=ftisiotwebsite">EverSQL</a>! üêß</p>
</p>

<h2 id="it-all-starts-with-some-columns-and-rows">It all starts with some columns and rows</h2>
<p>Let&rsquo;s start from the basics: you have a PostgreSQL¬Æ database and a table, called <code>users</code> like:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>id<span style="color:#bbb"> </span><span style="color:#008000">SERIAL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>username<span style="color:#bbb"> </span><span style="color:#008000">TEXT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">PRIMARY</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">KEY</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>name<span style="color:#bbb"> </span><span style="color:#008000">TEXT</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>surname<span style="color:#bbb"> </span><span style="color:#008000">TEXT</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>age<span style="color:#bbb"> </span><span style="color:#008000">INT</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>);<span style="color:#bbb">
</span></span></span></code></pre></div><blockquote>
<p>Hey, do you want to test the above code but not having a PostgreSQL database handy? Past your code in <a href="https://pgplayground.com/?utm_medium=organic&amp;utm_source=ext_blog&amp;utm_content=ftisiotNULL">PostgreSQL Playground</a> and quickly check the results!</p>
</blockquote>
<p>Let&rsquo;s insert some data:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">INTO</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span>(username,<span style="color:#bbb"> </span>name,<span style="color:#bbb"> </span>surname,<span style="color:#bbb"> </span>age)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">VALUES</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#ba2121">&#39;jdoe&#39;</span>,<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;Jon&#39;</span>,<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;Doe&#39;</span>,<span style="color:#bbb"> </span><span style="color:#666">25</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#ba2121">&#39;lspencer&#39;</span>,<span style="color:#ba2121">&#39;Liz&#39;</span>,<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;Spencer&#39;</span>,<span style="color:#bbb"> </span><span style="color:#666">35</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#ba2121">&#39;hlondon&#39;</span>,<span style="color:#ba2121">&#39;Hanna&#39;</span>,<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;London&#39;</span>,<span style="color:#bbb"> </span><span style="color:#666">45</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>Querying the data showcases the table with all the columns filled.</p>
<pre tabindex="0"><code> id | username | name  | surname | age 
----+----------+-------+---------+-----
  1 | jdoe     | Jon   | Doe     |  25
  2 | lspencer | Liz   | Spencer |  35
  3 | hlondon  | Hanna | London  |  45
(3 rows)
</code></pre><h2 id="insert-nulls">Insert NULLs</h2>
<p>Now, let&rsquo;s check if we can insert some <code>NULL</code>s, let&rsquo;s try by inserting them in the <code>name</code>, <code>surname</code> and <code>age</code> columns:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">INTO</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span>(username,<span style="color:#bbb"> </span>name,<span style="color:#bbb"> </span>surname,<span style="color:#bbb"> </span>age)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">VALUES</span><span style="color:#bbb"> </span>(<span style="color:#ba2121">&#39;test&#39;</span>,<span style="color:#008000;font-weight:bold">NULL</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>This works since we don&rsquo;t have any constraint</p>
<pre tabindex="0"><code> id | username | name  | surname | age 
----+----------+-------+---------+-----
  1 | jdoe     | Jon   | Doe     |  25
  2 | lspencer | Liz   | Spencer |  35
  3 | hlondon  | Hanna | London  |  45
  4 | test     |       |         |    
(4 rows)
</code></pre><p>We can even simplify the insert with the same effect</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">INTO</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span>(username)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">VALUES</span><span style="color:#bbb"> </span>(<span style="color:#ba2121">&#39;test1&#39;</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>Result:</p>
<pre tabindex="0"><code> id | username | name  | surname | age 
----+----------+-------+---------+-----
  1 | jdoe     | Jon   | Doe     |  25
  2 | lspencer | Liz   | Spencer |  35
  3 | hlondon  | Hanna | London  |  45
  4 | test     |       |         |    
  5 | test1    |       |         |    
(5 rows)
</code></pre><h2 id="inserting-nulls">Inserting NULLs</h2>
<p>The first step to avoid <code>NULL</code>s from appearing in a table is to forbid inserting them. The section below showcases a few situations on how to avoid inserting <code>NULL</code>s in new and existing columns.</p>
<h3 id="inserting-nulls-in-the-primary-key">Inserting NULLs in the primary key</h3>
<p>Can I insert a <code>NULL</code> in the table primary key? In theory this could be allowed since there&rsquo;s no explicit <code>NOT NULL</code> constraint on the column. Let&rsquo;s try:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">INTO</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span>(username)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">VALUES</span><span style="color:#bbb"> </span>(<span style="color:#008000;font-weight:bold">NULL</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>However this fails with:</p>
<pre tabindex="0"><code>ERROR:  null value in column &#34;username&#34; of relation &#34;users&#34; violates not-null constraint
DETAIL:  Failing row contains (6, null, null, null, null).
</code></pre><p><strong>üí° Lesson 1 üí°</strong>: Primary Keys are by default <code>NOT NULL</code></p>
<h3 id="create-a-new-column-with-not-null-constraint">Create a new column with NOT NULL constraint</h3>
<p>Let&rsquo;s add a new column to our table:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">ADD</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">COLUMN</span><span style="color:#bbb"> </span>points<span style="color:#bbb"> </span><span style="color:#008000">INT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>This will fail, since the previously inserted data don&rsquo;t have any associated value for <code>points</code></p>
<pre tabindex="0"><code>ERROR:  column &#34;points&#34; of relation &#34;users&#34; contains null values
</code></pre><p>Let&rsquo;s add a default value with:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">ADD</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">COLUMN</span><span style="color:#bbb"> </span>points<span style="color:#bbb"> </span><span style="color:#008000">INT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#666">0</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>The table was altered, and now contains <code>0 points</code> for all the existing rows.</p>
<pre tabindex="0"><code> id | username | name  | surname | age | points 
----+----------+-------+---------+-----+--------
  1 | jdoe     | Jon   | Doe     |  25 |      0
  2 | lspencer | Liz   | Spencer |  35 |      0
  3 | hlondon  | Hanna | London  |  45 |      0
  4 | test     |       |         |     |      0
  5 | test1    |       |         |     |      0
(5 rows)
</code></pre><p>If we try to insert a new row without specifying the <code>points</code> column:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">INTO</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span>(username)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">VALUES</span><span style="color:#bbb"> </span>(<span style="color:#ba2121">&#39;usrwithnullpoints&#39;</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>The row is inserted with the default <code>0 points</code></p>
<pre tabindex="0"><code> id |     username      | name  | surname | age | points 
----+-------------------+-------+---------+-----+--------
  1 | jdoe              | Jon   | Doe     |  25 |      0
  2 | lspencer          | Liz   | Spencer |  35 |      0
  3 | hlondon           | Hanna | London  |  45 |      0
  4 | test              |       |         |     |      0
  5 | test1             |       |         |     |      0
  7 | usrwithnullpoints |       |         |     |      0
(6 rows)
</code></pre><p>What if we try to push a <code>NULL</code> into <code>points</code>?</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">INTO</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span>(username,<span style="color:#bbb"> </span>points)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">VALUES</span><span style="color:#bbb"> </span>(<span style="color:#ba2121">&#39;forcenullpoints&#39;</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>We get the <code>ERROR:  null value in column &quot;points&quot; of relation &quot;users&quot; violates not-null constraint</code> stating that our insert is violating the <code>NOT NULL</code> constraint.</p>
<p><strong>üí° Lesson 2 üí°</strong>: Setting a <code>NOT NULL</code> constraint doesn&rsquo;t allow inserting <code>NULL</code>s</p>
<p><strong>üí° Lesson 3 üí°</strong>: If we want to add a <code>NOT NULL</code> column to an existing table with data, we need to specify the <strong>default</strong> value for existing rows.</p>
<h3 id="add-a-not-null-constraint-to-an-existing-column">Add a NOT NULL constraint to an existing column</h3>
<p>If we try to change an existing column (e.g. <code>name</code>) to add the <code>NOT NULL</code> constraint:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">COLUMN</span><span style="color:#bbb"> </span>name<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">SET</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>We get the similar error <code>ERROR:  column &quot;name&quot; of relation &quot;users&quot; contains null values</code>, therefore we need also need to amend the current <code>NULL</code> values (and possibly set a default)</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">COLUMN</span><span style="color:#bbb"> </span>name<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TYPE</span><span style="color:#bbb"> </span><span style="color:#008000">TEXT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">USING</span><span style="color:#bbb"> </span>(COALESCE(name,<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;Hugo&#39;</span>)),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">COLUMN</span><span style="color:#bbb"> </span>name<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">SET</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;Hugo&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">COLUMN</span><span style="color:#bbb"> </span>name<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">SET</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>In the above we:</p>
<ul>
<li>Altered the type, setting it to <code>TEXT</code> again, to apply the function <code>COALESCE(name, 'Hugo')</code> which is replacing <code>NULL</code>s in the <code>name</code> field with <code>Hugo</code></li>
<li>Set the default value for the <code>name</code> column to <code>Hugo</code> &lt;- This is not strictly necessary</li>
<li>Applied the <code>NOT NULL</code> constraint since we don&rsquo;t have any <code>NULL</code> values anymore</li>
</ul>
<blockquote>
<p>Note: the above method locks the entire table until done. A faster approach could be to split the <code>COALESCE(name, 'Hugo')</code> into a dedicated update and then only perform the <code>NOT NULL</code> and <code>DEFAULT</code> settings on the <code>ALTER TABLE</code> statement.</p>
</blockquote>
<p>The results are in line with the expected, no <code>NULL</code>s in the <code>name</code> column, being replaced by <code>Hugo</code></p>
<pre tabindex="0"><code> id |     username      | name  | surname | age | points 
----+-------------------+-------+---------+-----+--------
  1 | jdoe              | Jon   | Doe     |  25 |      0
  2 | lspencer          | Liz   | Spencer |  35 |      0
  3 | hlondon           | Hanna | London  |  45 |      0
  4 | test              | Hugo  |         |     |      0
  5 | test1             | Hugo  |         |     |      0
  7 | usrwithnullpoints | Hugo  |         |     |      0
(6 rows)
</code></pre><p><strong>üí° Lesson 4 üí°</strong>: If we need to add a <code>NOT NULL</code> column to an existing column in a table, we need to amend the existing <code>NULL</code> values and optionally set the <strong>default</strong> value for incoming rows.</p>
<p>What if I want to <strong>remove</strong> the <code>NOT NULL</code> constraint? We can do it with:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">COLUMN</span><span style="color:#bbb"> </span>name<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">DROP</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>;<span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="is-default-enough">Is DEFAULT enough?</h3>
<p>What if we leave the <code>NOT NULL</code> constraint aside, and just set the <code>DEFAULT</code>? Let&rsquo;s try with the <code>date_first_login</code> new column</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">ADD</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">COLUMN</span><span style="color:#bbb"> </span>date_first_login<span style="color:#bbb"> </span><span style="color:#008000">DATE</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">CURRENT_DATE</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>Checking what&rsquo;s in the table, we see all the <code>date_first_login</code> filled</p>
<pre tabindex="0"><code> id |     username      | name  | surname | age | points | date_first_login 
----+-------------------+-------+---------+-----+--------+------------------
  1 | jdoe              | Jon   | Doe     |  25 |      0 | 2024-02-27
  2 | lspencer          | Liz   | Spencer |  35 |      0 | 2024-02-27
  3 | hlondon           | Hanna | London  |  45 |      0 | 2024-02-27
  4 | test              | Hugo  |         |     |      0 | 2024-02-27
  5 | test1             | Hugo  |         |     |      0 | 2024-02-27
  7 | usrwithnullpoints | Hugo  |         |     |      0 | 2024-02-27
(6 rows)
</code></pre><p>If we try to insert a new row, without specifying the <code>date_first_login</code>, it&rsquo;s correctly assigned to today</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">INTO</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span>(username)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">VALUES</span><span style="color:#bbb"> </span>(<span style="color:#ba2121">&#39;user_with_no_date_first_login&#39;</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>The above is correctly inserted with a not null <code>date_first_login</code></p>
<pre tabindex="0"><code> id |           username            | name  | surname | age | points | date_first_login 
----+-------------------------------+-------+---------+-----+--------+------------------
  1 | jdoe                          | Jon   | Doe     |  25 |      0 | 2024-02-27
  2 | lspencer                      | Liz   | Spencer |  35 |      0 | 2024-02-27
  3 | hlondon                       | Hanna | London  |  45 |      0 | 2024-02-27
  4 | test                          | Hugo  |         |     |      0 | 2024-02-27
  5 | test1                         | Hugo  |         |     |      0 | 2024-02-27
  7 | usrwithnullpoints             | Hugo  |         |     |      0 | 2024-02-27
  9 | user_with_no_date_first_login | Hugo  |         |     |      0 | 2024-02-27
(7 rows)
</code></pre><p>So&hellip; is the <code>NOT NULL</code> constraint really needed? The reply is <strong>YES</strong> since I could insert <code>NULLs</code> by specifying it in the <code>INSERT</code> statement</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">INTO</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span>(username,<span style="color:#bbb"> </span>date_first_login)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">VALUES</span><span style="color:#bbb"> </span>(<span style="color:#ba2121">&#39;user_with_null_date_first_login&#39;</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>Which will be stored correctly with a <code>NULL</code> value for <code>date_first_login</code></p>
<pre tabindex="0"><code> id |            username             | name  | surname | age | points | date_first_login 
----+---------------------------------+-------+---------+-----+--------+------------------
  1 | jdoe                            | Jon   | Doe     |  25 |      0 | 2024-02-27
  2 | lspencer                        | Liz   | Spencer |  35 |      0 | 2024-02-27
  3 | hlondon                         | Hanna | London  |  45 |      0 | 2024-02-27
  4 | test                            | Hugo  |         |     |      0 | 2024-02-27
  5 | test1                           | Hugo  |         |     |      0 | 2024-02-27
  7 | usrwithnullpoints               | Hugo  |         |     |      0 | 2024-02-27
  9 | user_with_no_date_first_login   | Hugo  |         |     |      0 | 2024-02-27
 10 | user_with_null_date_first_login | Hugo  |         |     |      0 | 
(8 rows)
</code></pre><p><strong>üí° Lesson 5 üí°</strong>: The <code>DEFAULT</code> is going to prevent <code>NULL</code>s from being inserted only if the <code>NULL</code> is <strong>NOT</strong> specified in the target column. To enforce the value we need an explicit <code>NOT NULL</code> constraint</p>
<h2 id="querying-nulls">Querying NULLs</h2>
<p>In the above section we tried to avoid storing <code>NULL</code>s in our systems, what if we need to deal with existing <code>NULL</code>s in our column? Here we can use a few SQL functions to detect them and change their value.</p>
<h3 id="detecting-nulls-with-the-is-null-condition">Detecting NULLs with the <code>IS NULL</code> condition</h3>
<p>What if we want to detect the <code>NULL</code> values? We can use the <code>IS NULL</code> condition, for example:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">from</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">where</span><span style="color:#bbb"> </span>surname<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">IS</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>Which will retrieve the list of <code>NULL</code>s surnames</p>
<pre tabindex="0"><code> id |            username             | name | surname | age | points | date_first_login 
----+---------------------------------+------+---------+-----+--------+------------------
  4 | test                            | Hugo |         |     |      0 | 2024-02-27
  5 | test1                           | Hugo |         |     |      0 | 2024-02-27
  7 | usrwithnullpoints               | Hugo |         |     |      0 | 2024-02-27
  9 | user_with_no_date_first_login   | Hugo |         |     |      0 | 2024-02-27
 10 | user_with_null_date_first_login | Hugo |         |     |      0 | 
(5 rows)
</code></pre><p>The opposite list could be retrieved by applying the <code>IS NOT NULL</code> condition:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">from</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">where</span><span style="color:#bbb"> </span>surname<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">IS</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>Resulting in</p>
<pre tabindex="0"><code> id | username | name  | surname | age | points | date_first_login 
----+----------+-------+---------+-----+--------+------------------
  1 | jdoe     | Jon   | Doe     |  25 |      0 | 2024-02-27
  2 | lspencer | Liz   | Spencer |  35 |      0 | 2024-02-27
  3 | hlondon  | Hanna | London  |  45 |      0 | 2024-02-27
(3 rows)
</code></pre><p>What if I try to use the equal comparison (<code>=</code>)</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">from</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">where</span><span style="color:#bbb"> </span>surname<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>The above retrieves <strong>NO rows</strong> since the <code>NULL</code> value means there is <strong>NO value</strong> and is <strong>NOT</strong> equal to any other value (<code>NULL</code>=<code>NULL</code> is <strong>False</strong>)</p>
<pre tabindex="0"><code> id | username | name | surname | age | points | date_first_login 
----+----------+------+---------+-----+--------+------------------
(0 rows)
</code></pre><p>If we apply the different operator (<code>&lt;&gt;</code>) with <code>NULL</code> we also get back <strong>NO rows</strong>, since the <code>NULL</code> value means there is <strong>NO value</strong>, and therefore is not equal or different to other values.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">from</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">where</span><span style="color:#bbb"> </span>surname<span style="color:#bbb"> </span><span style="color:#666">&lt;&gt;</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p><strong>üí° Lesson 6 üí°</strong>: To find <code>NULL</code>s we should always use the <code>IS NULL</code>; the <code>IS NOT NULL</code> to fetch the not null rows.</p>
<h3 id="associating-a-default-value-to-nulls-with-coalesce">Associating a default value to NULLs with COALESCE</h3>
<p>In the above we saw how to find <code>NULL</code>s, what if we need to include them in a <code>SELECT</code> statement with other values? We can either add an <code>OR</code> condition like</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">from</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">WHERE</span><span style="color:#bbb"> </span>surname<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;London&#39;</span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">OR</span><span style="color:#bbb"> </span>surname<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">IS</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>Or we can apply a transformation to change the <code>NULL</code>s into a value we can compare</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">from</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">WHERE</span><span style="color:#bbb"> </span>COALESCE(surname,<span style="color:#ba2121">&#39;Verona&#39;</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">in</span><span style="color:#bbb"> </span>(<span style="color:#ba2121">&#39;London&#39;</span>,<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;Verona&#39;</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>Both will have the same result</p>
<pre tabindex="0"><code> id |            username             | name  | surname | age | points | date_first_login 
----+---------------------------------+-------+---------+-----+--------+------------------
  3 | hlondon                         | Hanna | London  |  45 |      0 | 2024-02-27
  4 | test                            | Hugo  |         |     |      0 | 2024-02-27
  5 | test1                           | Hugo  |         |     |      0 | 2024-02-27
  7 | usrwithnullpoints               | Hugo  |         |     |      0 | 2024-02-27
  9 | user_with_no_date_first_login   | Hugo  |         |     |      0 | 2024-02-27
 10 | user_with_null_date_first_login | Hugo  |         |     |      0 | 
(6 rows)
</code></pre><p>However, if we apply the second option, we must be sure that <code>Verona</code> (the label we associate to <code>NULL</code> values) is a value not present in the column or a value we want to include in our selection.</p>
<p><strong>üí° Lesson 7 üí°</strong>: When using <code>COALESCE</code> check out that the value you want to use as substitute of <code>NULL</code> is not already present in the table and outside of your business logic otherwise you might include in the filter more values than expected.</p>
<h3 id="performing-math-on-null-columns">Performing Math on NULL columns</h3>
<p>A similar scenario is due when we need to perform a calculation over a <code>NULL</code>able column. Let&rsquo;s take the example of the <code>age</code> column: what if we want to calculate the average age?</p>
<p>Let&rsquo;s see the data:</p>
<pre tabindex="0"><code> id |            username             | name  | surname | age | points | date_first_login 
----+---------------------------------+-------+---------+-----+--------+------------------
  1 | jdoe                            | Jon   | Doe     |  25 |      0 | 2024-02-27
  2 | lspencer                        | Liz   | Spencer |  35 |      0 | 2024-02-27
  3 | hlondon                         | Hanna | London  |  45 |      0 | 2024-02-27
  4 | test                            | Hugo  |         |     |      0 | 2024-02-27
  5 | test1                           | Hugo  |         |     |      0 | 2024-02-27
  7 | usrwithnullpoints               | Hugo  |         |     |      0 | 2024-02-27
  9 | user_with_no_date_first_login   | Hugo  |         |     |      0 | 2024-02-27
 10 | user_with_null_date_first_login | Hugo  |         |     |      0 | 
(8 rows)
</code></pre><p>We can calculate the average age with:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">select</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">avg</span>(age)<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">from</span><span style="color:#bbb"> </span>users;<span style="color:#bbb">
</span></span></span></code></pre></div><p>Resulting in <code>35</code> which is the average between the 3 <strong>NOT NULL</strong> ages! Similarly if we count the <code>date_first_login</code>s with:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">select</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">count</span>(date_first_login)<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">from</span><span style="color:#bbb"> </span>users;<span style="color:#bbb">
</span></span></span></code></pre></div><p>The result is <code>7</code>, one row for every user having a not null <code>date_first_login</code></p>
<p><strong>üí° Lesson 8 üí°</strong>: When performing Mathematical operation with nullable columns, only <strong>NOT NULL</strong> values will be elaborated!</p>
<p>What if we try to calculate the average <code>points</code>? First let&rsquo;s update the table to give <code>jdoe</code> 25 points</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">UPDATE</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">set</span><span style="color:#bbb"> </span>points<span style="color:#666">=</span><span style="color:#666">25</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">where</span><span style="color:#bbb"> </span>username<span style="color:#666">=</span><span style="color:#ba2121">&#39;jdoe&#39;</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>Now let&rsquo;s calcuate the average points</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">select</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">avg</span>(points)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">from</span><span style="color:#bbb"> </span>users;<span style="color:#bbb">
</span></span></span></code></pre></div><p>The result is <code>3.125</code> which is the mathematical average between the <code>25</code> points of <code>jdoe</code> and the <code>0</code> of the rest due to us previously setting <code>0</code> as default value. Is this correct? It depends! If we wanted to calculate the average number of points of users actually playing some games, this could be a misleading calculation.</p>
<p><strong>üí° Lesson 9 üí°</strong>: When performing Mathematical operation with nullable columns, the default value of a column will impact the results.</p>
<h3 id="joining-on-null-columns">Joining on NULL columns</h3>
<p>Building on what we explored before about the <code>NULL</code> not being equal or different to any other value, we need to pay closer attention when we deal with nullable columns in join condition.</p>
<p>Let&rsquo;s create another table called <code>sessions</code> and insert some data. For a weird reason, the design of this table will force us to join with <code>users</code> on the <code>surname</code> which is a NULLABLE field.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>sessions<span style="color:#bbb"> </span>(id<span style="color:#bbb"> </span><span style="color:#008000">serial</span>,<span style="color:#bbb"> </span>surname<span style="color:#bbb"> </span><span style="color:#008000">text</span>,<span style="color:#bbb"> </span>session_time<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">timestamp</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">INTO</span><span style="color:#bbb"> </span>sessions<span style="color:#bbb"> </span>(surname,<span style="color:#bbb"> </span>session_time)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">values</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#ba2121">&#39;Doe&#39;</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">CURRENT_TIMESTAMP</span><span style="color:#bbb"> </span><span style="color:#666">-</span><span style="color:#bbb"> </span><span style="color:#008000">INTERVAL</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;1 day&#39;</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#ba2121">&#39;Doe&#39;</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">CURRENT_TIMESTAMP</span><span style="color:#bbb"> </span><span style="color:#666">-</span><span style="color:#bbb"> </span><span style="color:#008000">INTERVAL</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;1 day&#39;</span><span style="color:#666">*</span><span style="color:#666">2</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#ba2121">&#39;Spencer&#39;</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">CURRENT_TIMESTAMP</span><span style="color:#bbb"> </span><span style="color:#666">-</span><span style="color:#bbb"> </span><span style="color:#008000">INTERVAL</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;1 day&#39;</span><span style="color:#666">*</span><span style="color:#666">2</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#ba2121">&#39;Spencer&#39;</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">CURRENT_TIMESTAMP</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#008000;font-weight:bold">NULL</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">CURRENT_TIMESTAMP</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#008000;font-weight:bold">NULL</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">CURRENT_TIMESTAMP</span><span style="color:#bbb"> </span><span style="color:#666">-</span><span style="color:#bbb"> </span><span style="color:#008000">INTERVAL</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;1 day&#39;</span><span style="color:#666">*</span><span style="color:#666">2</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#008000;font-weight:bold">NULL</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">CURRENT_TIMESTAMP</span><span style="color:#bbb"> </span><span style="color:#666">-</span><span style="color:#bbb"> </span><span style="color:#008000">INTERVAL</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;1 day&#39;</span><span style="color:#666">*</span><span style="color:#666">2</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#008000;font-weight:bold">NULL</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">CURRENT_TIMESTAMP</span><span style="color:#bbb"> </span><span style="color:#666">-</span><span style="color:#bbb"> </span><span style="color:#008000">INTERVAL</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;1 day&#39;</span><span style="color:#666">*</span><span style="color:#666">1</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#008000;font-weight:bold">NULL</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">CURRENT_TIMESTAMP</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>Now, if we want to count users having a session on each day we could think of simply writing the above query:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">EXTRACT</span>(<span style="color:#008000;font-weight:bold">DAY</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>session_time),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">count</span>(<span style="color:#008000;font-weight:bold">distinct</span><span style="color:#bbb"> </span>username)<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>sessions<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">join</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">on</span><span style="color:#bbb"> </span>sessions.surname<span style="color:#666">=</span>users.surname<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">group</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">by</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">EXTRACT</span>(<span style="color:#008000;font-weight:bold">DAY</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>session_time);<span style="color:#bbb">
</span></span></span></code></pre></div><p>However the results shows only the 4 sessions below</p>
<pre tabindex="0"><code> extract | count 
---------+-------
      25 |     2
      26 |     1
      27 |     1
(3 rows)
</code></pre><p>Why? It&rsquo;s again because of <code>NULL</code> values in the join condition. This problem of poor data quality on both ends of the join is stopping us from reporting any useful number. How could we fix it? Well, the fix should be done uphill by setting the <code>sessions</code> table to use the <code>username</code> instead of the <code>surname</code> and defining a proper <code>FOREIGN KEY</code> to the <code>users</code> table.</p>
<p><strong>üí° Lesson 10 üí°</strong>: Joining tables on nullable columns without caring about the NULL management will impact the results by reducing the number of rows included in the join.</p>
<p>Still, if we want a simplistic solution, we could do the apply the <code>COALESCE</code> to both sides of the join:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">EXTRACT</span>(<span style="color:#008000;font-weight:bold">DAY</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>session_time),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">count</span>(<span style="color:#008000;font-weight:bold">distinct</span><span style="color:#bbb"> </span>username)<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>sessions<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">join</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">on</span><span style="color:#bbb"> </span>coalesce(sessions.surname,<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;NoSurname&#39;</span>)<span style="color:#666">=</span>coalesce(users.surname,<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;NoSurname&#39;</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">group</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">by</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">EXTRACT</span>(<span style="color:#008000;font-weight:bold">DAY</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>session_time);<span style="color:#bbb">
</span></span></span></code></pre></div><p>The result shows an increased count of sessions</p>
<pre tabindex="0"><code> extract | count 
---------+-------
      25 |     7
      26 |     6
      27 |     6
(3 rows)
</code></pre><p>However this is still not the correct answer, since we are seeing <code>19</code> session being aggregated while only <code>9</code> sessions were inserted in the original <code>sessions</code> table. Why is that? It&rsquo;s because we now casted all the <code>NULL</code>s as <code>NoSurname</code> on both sides of the join. Since we had <code>5</code> sessions without <code>surname</code> and <code>5</code> users without <code>surname</code> we are creating a cartesian join of all the empty surnames with the empty sessions.</p>
<p>We had the following users without <code>surname</code></p>
<pre tabindex="0"><code>test
test1
usrwithnullpoints
user_with_no_date_first_login
user_with_null_date_first_login
</code></pre><p>And the following sessions without <code>surname</code></p>
<pre tabindex="0"><code>  6 | 2024-02-27 14:10:08.419021
  7 | 2024-02-25 14:10:08.419021
  8 | 2024-02-25 14:10:08.419021
  9 | 2024-02-26 14:10:08.419021
 10 | 2024-02-27 14:10:08.419021
</code></pre><p>Each of the users was associated with each sessions, creating a overflow of sessions.</p>
<p>A more correct solution, attribuiting all the <code>NULL</code> session to a same phantom user <code>NoUser</code> could be:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">EXTRACT</span>(<span style="color:#008000;font-weight:bold">DAY</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>session_time),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">count</span>(<span style="color:#008000;font-weight:bold">distinct</span><span style="color:#bbb"> </span>coalesce(username,<span style="color:#ba2121">&#39;NoUser&#39;</span>))<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>sessions<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">left</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">outer</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">join</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">on</span><span style="color:#bbb"> </span>sessions.surname<span style="color:#666">=</span>users.surname<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">group</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">by</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">EXTRACT</span>(<span style="color:#008000;font-weight:bold">DAY</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>session_time);<span style="color:#bbb">
</span></span></span></code></pre></div><p>However this is an effort to fix data quality issues at query time, which is never a good idea.</p>
<p><strong>üí° Lesson 11 üí°</strong>: Fixing data quality issues related to nullable columns at query time is a risky approach. Solving them with proper table design and constraints allows you to keep quality data in the tables.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Dealing with <code>NULL</code>s is something to care upfront, during table design, in order to avoid data quality issues downstream!
This is it for the 11 lessons learnt using <code>NULL</code>s, do you have others to share? Feel free to reach me on X/Twitter at @ftisiot or on <a href="https://www.linkedin.com/in/francescotisiot/">Linkedin</a></p>
</article>

		</main>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide">
		<div class="about-the-author">
		
			
			
				
					<hr>
<p><img src="/images/ftisiot.jpg" alt="Francesco Tisiot"></p>
<p><a href="https://www.linkedin.com/in/francescotisiot/"><b class="fab fa-linkedin"></b></a> <a href="https://twitter.com/FTisiot"><b class="fab fa-twitter"></b></a><a rel="me" href="https://data-folks.masto.host/@ftisiot">Mastodon</a> Francesco comes from Verona, Italy üáÆüáπ and works as a Staff Developer Advocate at Aiven. With his many years of experience as a data analyst, he has stories to tell and advice for data-wranglers  everywhere. Francesco loves sharing knowledge with others as a speaker and writer, and is on a mission to defend the world from bad Italian food!!</p>

				
			
		
		</div>
		
	</div>

		
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			<a class="no-underline near-white" href="https://github.com/xaprb/story"><img class="dib" title="Made with Hugo and Story" alt="Story logo" src="https://ftisiot.net/img/story-logo-white.svg" style="width: 1.5rem; height: 1.5rem" /></a>
			</p>
			<p class="w-50 near-white">
				&copy; 2024 
			</p>
		</footer>
		
	
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-7Z74BTZ0TM', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	
	</body>
</html>
